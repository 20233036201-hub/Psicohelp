<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - PsicoHelp</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" onclick="window.location.href='/home'">üè† Home</button>
            <button class="nav-btn" onclick="window.location.href='/agendar'">üìÖ Agendar</button>
            <button class="nav-btn" onclick="window.location.href='/minhas_consultas'">üìã Consultas</button>
            <button class="nav-btn active" onclick="window.location.href='/perfil'">üë§ Perfil</button>
            <button class="nav-btn btn-danger" onclick="logout()">üö™ Sair</button>
        </div>
        
        <h1>üë§ Meu Perfil</h1>
        
        <div id="profile-content">
            <div class="loading">Carregando informa√ß√µes...</div>
        </div>
        
        <div id="profile-actions" style="margin-top: 30px;"></div>
    </div>
    
    <!-- Modal Editar Perfil -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Editar Perfil</div>
                <button class="modal-close" onclick="fecharModalEditar()">‚úï</button>
            </div>
            
            <form id="formEditar">
                <label for="editNome">Nome:</label>
                <input type="text" id="editNome" required>
                
                <label for="editTelefone">Telefone:</label>
                <input type="tel" id="editTelefone">
                
                <div id="editPsicologoFields" style="display: none;">
                    <label for="editExperiencia">Anos de Experi√™ncia:</label>
                    <input type="number" id="editExperiencia" min="0" max="50">
                    
                    <label for="editDescricao">Sobre voc√™:</label>
                    <textarea id="editDescricao" placeholder="Fale sobre sua experi√™ncia..."></textarea>
                </div>
                
                <button type="submit" class="btn">üíæ Salvar Altera√ß√µes</button>
                <button type="button" class="btn btn-secondary" onclick="fecharModalEditar()">Cancelar</button>
            </form>
        </div>
    </div>
    <script src="../navbar.js"></script>
    <script>
        let usuarioAtual = null;
        
        // Carregar perfil
        async function carregarPerfil() {
            try {
                const response = await fetch('/api/usuario/atual', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                usuarioAtual = await response.json();
                mostrarPerfil(usuarioAtual);
                
            } catch (error) {
                document.getElementById('profile-content').innerHTML = `
                    <div class="error-message">
                        ‚ùå Erro ao carregar perfil
                        <button onclick="carregarPerfil()" class="btn" style="margin-top: 10px;">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        }
        
        // Mostrar perfil
        function mostrarPerfil(usuario) {
            const tipoFormatado = {
                'cliente': 'üë§ Cliente',
                'psicologo': 'üë®‚Äç‚öïÔ∏è Psic√≥logo',
                'moderador': 'üõ°Ô∏è Moderador'
            }[usuario.tipo] || usuario.tipo;
            
            const primeiraLetra = usuario.nome ? usuario.nome.charAt(0).toUpperCase() : '?';
            
            let infoExtra = '';
            
            if (usuario.tipo === 'psicologo') {
                infoExtra = `
                    <div class="info-item">
                        <span class="info-label">üìÑ CRP:</span>
                        <span class="info-value">${usuario.CRP || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üéØ Especialidade:</span>
                        <span class="info-value">${usuario.especialidade || 'N√£o informada'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üéì Forma√ß√£o:</span>
                        <span class="info-value">${usuario.formacao || 'N√£o informada'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üß† Abordagem:</span>
                        <span class="info-value">${usuario.abordagem || 'N√£o informada'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">‚è≥ Experi√™ncia:</span>
                        <span class="info-value">${usuario.experiencia || 0} anos</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üìä Status:</span>
                        <span class="info-value">${usuario.status_psicologo === 'ativo' ? '‚úÖ Ativo' : '‚è≥ Pendente'}</span>
                    </div>
                    ${usuario.descricao ? `
                    <div class="info-item">
                        <span class="info-label">üìù Sobre:</span>
                        <span class="info-value">${usuario.descricao}</span>
                    </div>
                    ` : ''}
                `;
            }
            
            document.getElementById('profile-content').innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">${primeiraLetra}</div>
                    <h2>${usuario.nome}</h2>
                    <p style="color: #ffcc66; font-weight: bold;">${tipoFormatado}</p>
                </div>
                
                <div class="profile-info">
                    <div class="info-item">
                        <span class="info-label">üìß Email:</span>
                        <span class="info-value">${usuario.email}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üìû Telefone:</span>
                        <span class="info-value">${usuario.telefone || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üìÖ Data de Cadastro:</span>
                        <span class="info-value">${new Date(usuario.data_cadastro).toLocaleDateString('pt-BR')}</span>
                    </div>
                    ${infoExtra}
                </div>
            `;
            
            // Bot√µes de a√ß√£o
            let botoes = '';
            
            if (usuario.tipo === 'moderador') {
                botoes = `
                    <button class="btn" onclick="window.location.href='/moderador'">
                        üõ°Ô∏è Painel do Moderador
                    </button>
                `;
            }
            
            // Para psic√≥logos, mostrar bot√£o para ver suas consultas (pacientes)
            if (usuario.tipo === 'psicologo') {
                botoes += `
                    <button class="btn" onclick="window.location.href='/psicologo/consultas'">
                        üìã Minhas Consultas (Pacientes)
                    </button>
                `;
            }
            
            botoes += `
                <button class="btn" onclick="abrirModalEditar()">
                    ‚úèÔ∏è Editar Perfil
                </button>
                <button class="btn btn-danger" onclick="confirmarLogout()">
                    üö™ Sair da Conta
                </button>
            `;
            
            document.getElementById('profile-actions').innerHTML = botoes;
        }      
        // Modal editar
        function abrirModalEditar() {
            if (!usuarioAtual) return;
            
            document.getElementById('editNome').value = usuarioAtual.nome || '';
            document.getElementById('editTelefone').value = usuarioAtual.telefone || '';
            
            if (usuarioAtual.tipo === 'psicologo') {
                document.getElementById('editPsicologoFields').style.display = 'block';
                document.getElementById('editExperiencia').value = usuarioAtual.experiencia || 0;
                document.getElementById('editDescricao').value = usuarioAtual.descricao || '';
            } else {
                document.getElementById('editPsicologoFields').style.display = 'none';
            }
            
            document.getElementById('modalEditar').style.display = 'flex';
        }
        
        function fecharModalEditar() {
            document.getElementById('modalEditar').style.display = 'none';
        }
        
        // Salvar altera√ß√µes
        document.getElementById('formEditar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('editNome').value.trim();
            const telefone = document.getElementById('editTelefone').value.trim();
            const experiencia = document.getElementById('editExperiencia')?.value || 0;
            const descricao = document.getElementById('editDescricao')?.value || '';
            const btn = this.querySelector('.btn');
            
            btn.textContent = 'Salvando...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        nome,
                        telefone,
                        experiencia,
                        descricao
                    })
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    fecharModalEditar();
                    alert('‚úÖ Perfil atualizado com sucesso!');
                    carregarPerfil(); // Recarregar
                } else {
                    alert('‚ùå ' + resultado.error);
                    btn.textContent = 'üíæ Salvar Altera√ß√µes';
                    btn.disabled = false;
                }
                
            } catch (error) {
                alert('‚ùå Erro ao atualizar perfil');
                console.error('Erro:', error);
                btn.textContent = 'üíæ Salvar Altera√ß√µes';
                btn.disabled = false;
            }
        });
        
        // Logout
        function confirmarLogout() {
            if (confirm('Tem certeza que deseja sair da sua conta?')) {
                logout();
            }
        }
        
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Inicializar
        window.onload = carregarPerfil;
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalEditar();
            }
        });
    </script>
</body>
</html>