<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Consulta - PsicoHelp</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" onclick="window.location.href='/home'">üè† Home</button>
            <button class="nav-btn active" onclick="window.location.href='/agendar'">üìÖ Agendar</button>
            <button class="nav-btn" onclick="window.location.href='/minhas_consultas'">üìã Consultas</button>
            <button class="nav-btn" onclick="window.location.href='/perfil'">üë§ Perfil</button>
            <button class="nav-btn btn-danger" onclick="logout()">üö™ Sair</button>
        </div>
        
        <h1>üë®‚Äç‚öïÔ∏è Encontre seu Psic√≥logo</h1>
        <p style="text-align: center; color: rgba(255, 255, 255, 0.8); margin-bottom: 30px;">
            Escolha um profissional para agendar sua consulta
        </p>
        
        <div id="lista-psicologos">
            <div class="loading">Carregando psic√≥logos...</div>
        </div>
    </div>
    <script src="../navbar.js"></script>
    <script>
        let usuarioAtual = null;
        
        // Verificar autentica√ß√£o
        async function verificarAutenticacao() {
            try {
                const response = await fetch('/api/usuario/atual', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                usuarioAtual = await response.json();
                
                // Se n√£o for cliente, redirecionar
                if (usuarioAtual.tipo !== 'cliente') {
                    alert('Apenas clientes podem agendar consultas.');
                    window.location.href = '/home';
                    return;
                }
                
                carregarPsicologos();
                
            } catch (error) {
                console.error('Erro:', error);
                window.location.href = '/';
            }
        }
        
        // Carregar psic√≥logos
        async function carregarPsicologos() {
            try {
                const response = await fetch('/api/psicologos', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar psic√≥logos');
                }
                
                const psicologos = await response.json();
                mostrarPsicologos(psicologos);
                
            } catch (error) {
                document.getElementById('lista-psicologos').innerHTML = `
                    <div class="error-message">
                        ‚ùå Erro ao carregar psic√≥logos
                        <button onclick="carregarPsicologos()" class="btn" style="margin-top: 10px;">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        }
        
        // Mostrar psic√≥logos
        function mostrarPsicologos(psicologos) {
            const container = document.getElementById('lista-psicologos');
            
            if (!psicologos || psicologos.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>üë®‚Äç‚öïÔ∏è Nenhum psic√≥logo dispon√≠vel</h3>
                        <p>No momento n√£o h√° psic√≥logos cadastrados no sistema.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = psicologos.map(psicologo => `
                <div class="psychologist-card" onclick="selecionarPsicologo(${psicologo.id_psicologo}, '${psicologo.nome.replace(/'/g, "\\'")}')"> <!-- MUDADO: id_psicologo -->
                    <div class="psychologist-name">${psicologo.nome}</div>
                    <div class="psychologist-specialty">
                        <strong>Especialidade:</strong> ${psicologo.especialidade || 'Geral'}<br>
                        <strong>Abordagem:</strong> ${psicologo.abordagem || 'N√£o informada'}<br>
                        <strong>Experi√™ncia:</strong> ${psicologo.experiencia || 0} anos
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="psychologist-rating">‚≠ê ${psicologo.avaliacao_media || '0.00'} (${psicologo.total_avaliacoes || 0} avalia√ß√µes)</span>
                        <span style="float: right; background: #ffcc66; color: #007f7f; padding: 3px 10px; border-radius: 15px; font-size: 0.9em;">
                            CRP: ${psicologo.CRP || 'N/I'}
                        </span>
                    </div>
                    <button class="btn" style="margin-top: 15px;">‚úÖ Agendar Consulta</button>
                </div>
            `).join('');
        }

        function selecionarPsicologo(idPsicologo, nomePsicologo) { // MUDADO: id_psicologo
            window.location.href = `/confirmar_agendamento?id_psicologo=${idPsicologo}&nome=${encodeURIComponent(nomePsicologo)}`;
        }   
        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Inicializar
        window.onload = verificarAutenticacao;
    </script>
</body>
</html>