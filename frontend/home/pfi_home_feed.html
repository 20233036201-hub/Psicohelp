<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Psico - Feed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #007f7f, #009999);
      color: white;
    }

    /* HEADER */
    header {
      background: transparent;
      text-align: center;
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      color: #ffcc66;
      font-size: 32px;
      margin: 0;
    }

    header p {
      color: white;
      opacity: 0.9;
    }

    /* CONTAINER PRINCIPAL */
    .content {
      max-width: 800px;
      margin: 0 auto 100px auto;
      padding: 0 20px;
    }

    /* TITULO */
    .content h2 {
      text-align: center;
      color: #ffcc66;
      margin-bottom: 20px;
    }

    /* POST */
    .feed-post {
      background: #009999;
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 2px solid #ffcc66;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      color: white;
    }

    .feed-post-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.95em;
    }

    .feed-post-author {
      font-weight: bold;
      color: #ffcc66;
    }

    .feed-post-date {
      color: #ffe9b3;
    }

    .feed-post-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #ffcc66;
      margin-bottom: 10px;
    }

    .feed-post-content {
      white-space: pre-line;
      margin-bottom: 15px;
      line-height: 1.6;
      color: white;
    }

    /* A√á√ïES */
    .feed-like-btn {
      border: 2px solid #ffcc66;
      background: transparent;
      color: #ffcc66;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .feed-like-btn:hover {
      background: rgba(255, 204, 102, 0.2);
    }

    .feed-likes-count {
      font-weight: bold;
    }

    /* MODAL */
    .feed-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .feed-modal-content {
      background: #009999;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      border: 2px solid #ffcc66;
    }

    .feed-modal-content h3 {
      color: #ffcc66;
      margin-top: 0;
    }

    .feed-modal-content textarea,
    .feed-modal-content input {
      width: 94%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #ffcc66;
      border-radius: 8px;
      background-color: #e6e6e6;
    }

    /* BOT√ïES MODAL */
    .feed-btn-primary {
      background: #ffcc66;
      color: #007f7f;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .feed-btn-primary:hover {
      background: #ffb84d;
    }

    /* BOT√ÉO DE + NOVO POST */
    .feed-new-post-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #ffcc66;
      color: #007f7f;
      border: none;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      z-index: 2000;
    }

    /* NAV BOTTOM */
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #009999;
      display: flex;
      justify-content: space-around;
      padding: 10px;
      border-top: 2px solid #ffcc66;
    }

    nav button {
      background: #ffcc66;
      color: #007f7f;
      border: none;
      padding: 12px 15px;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: bold;
      width: 23%;
      cursor: pointer;
    }

    nav button:hover {
      background: #ffb84d;
    }
  </style>
</head>
<body>

  <header>
    <h1>PsicoHelp</h1>
    <p>Compartilhe sua jornada de supera√ß√£o üí™</p>
  </header>

  <div class="content">
    <h2>Feed de Inspira√ß√£o</h2>
    <div id="feed-container">
      <div class="loading">Carregando posts...</div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="postModal" class="feed-modal">
    <div class="feed-modal-content">
      <h3>Compartilhe Sua Hist√≥ria</h3>
      <input type="text" id="postTitle" placeholder="T√≠tulo da sua hist√≥ria..." maxlength="100">
      <textarea id="postContent" placeholder="Conte sua jornada..." rows="6" maxlength="1000"></textarea>
      <div class="feed-modal-buttons">
        <button onclick="fecharModal()">Cancelar</button>
        <button onclick="criarPost()" class="feed-btn-primary">Publicar</button>
      </div>
    </div>
  </div>

  <!-- BOT√ÉO DE NOVO POST -->
  <button class="feed-new-post-btn" onclick="abrirModal()">+</button>

  <!-- NAVEGA√á√ÉO -->
  <nav>
    <button onclick="window.location.href='/agendar'">üìÖ Agendar</button>
    <button onclick="window.location.href='/home'">üì∞ Feed</button>
    <button onclick="window.location.href='/minhas_consultas'">üìã Consultas</button>
    <button onclick="window.location.href='/perfil'">üë§ Perfil</button>
  </nav>

  <script>
    // FUN√á√ïES DO MODAL
    function abrirModal() {
        document.getElementById('postModal').style.display = 'flex';
    }

    function fecharModal() {
        document.getElementById('postModal').style.display = 'none';
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
    }

    // Teste de sess√£o
    async function testarSessao() {
        try {
            const response = await fetch('/api/debug-session', {
                credentials: 'include'
            });
            const data = await response.json();
            console.log('üîç Debug Sess√£o:', data);
        } catch (error) {
            console.error('Erro ao testar sess√£o:', error);
        }
    }

    window.onload = function () {
        testarSessao();
        carregarFeed();
    };

    async function carregarFeed() {
        try {
            const response = await fetch('/api/feed', {
                credentials: 'include'
            });
            const posts = await response.json();
            mostrarPosts(posts);
        } catch (error) {
            document.getElementById('feed-container').innerHTML =
                '<div class="loading">Erro ao carregar posts</div>';
        }
    }

    function mostrarPosts(posts) {
        const container = document.getElementById('feed-container');

        if (!posts || posts.length === 0) {
            container.innerHTML =
                '<div class="feed-post"><p>Nenhum post ainda. Seja o primeiro a compartilhar! üòä</p></div>';
            return;
        }

        container.innerHTML = posts
            .map(
                (post) => `
            <div class="feed-post">
                <div class="feed-post-header">
                    <span class="feed-post-author">${post.nome_cliente}</span>
                    <span class="feed-post-date">${new Date(
                        post.data_postagem
                    ).toLocaleDateString('pt-BR')}</span>
                </div>

                <div class="feed-post-title">${post.titulo}</div>

                <div class="feed-post-content">${post.conteudo}</div>

                <div class="feed-post-actions">
                    <button class="feed-like-btn" onclick="curtirPost(${post.id_relato})">
                        ‚ù§Ô∏è <span class="feed-likes-count">${post.curtidas || 0}</span>
                    </button>
                </div>
            </div>`
            )
            .join('');
    }

    async function curtirPost(id) {
        try {
            await fetch('/api/feed/curtir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ id_relato: id }),
            });
            carregarFeed();
        } catch (err) {
            console.log('Erro ao curtir');
        }
    }

    async function criarPost() {
        const titulo = document.getElementById('postTitle').value;
        const conteudo = document.getElementById('postContent').value;

        if (!titulo || !conteudo) {
            alert('Preencha t√≠tulo e conte√∫do!');
            return;
        }

        try {
            const response = await fetch('/api/feed/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ titulo, conteudo }),
            });

            const result = await response.json();

            if (result.success) {
                fecharModal();
                carregarFeed();
                alert('Post criado com sucesso!');
            }
        } catch (error) {
            alert('Erro ao criar post');
        }
    }
  </script>

</body>
</html>