<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Agendamento - PsicoHelp</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" onclick="window.location.href='/home'">üè† Home</button>
            <button class="nav-btn" onclick="window.location.href='/agendar'">üìÖ Agendar</button>
            <button class="nav-btn" onclick="window.location.href='/minhas_consultas'">üìã Consultas</button>
            <button class="nav-btn" onclick="window.location.href='/perfil'">üë§ Perfil</button>
            <button class="nav-btn btn-danger" onclick="logout()">üö™ Sair</button>
        </div>
        
        <h1>üìÖ Confirmar Agendamento</h1>
        
        <div id="psicologo-info" style="text-align: center; margin-bottom: 30px;">
            <div class="loading">Carregando informa√ß√µes...</div>
        </div>
        
        <form id="formAgendamento">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="data">Data:</label>
                    <input type="date" id="data" required>
                </div>
                <div>
                    <label for="horario">Hor√°rio:</label>
                    <select id="horario" required>
                        <option value="">Selecione</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                        <option value="18:00">18:00</option>
                    </select>
                </div>
            </div>
            
            <label for="observacoes">Observa√ß√µes (opcional):</label>
            <textarea id="observacoes" placeholder="Alguma informa√ß√£o importante..."></textarea>
            
            <div style="margin: 20px 0;">
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="termos" required style="width: auto; margin-right: 10px;">
                    Aceito os termos de servi√ßo
                </label>
            </div>
            
            <button type="submit" class="btn btn-success">‚úÖ Confirmar Agendamento</button>
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">‚Ü©Ô∏è Voltar</button>
        </form>
    </div>
    <script src="../navbar.js"></script>
    <script>
        let psicologoInfo = null;
        
        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const idPsicologo = urlParams.get('id_psicologo');
        const nomePsicologo = urlParams.get('nome');
        
        // Verificar autentica√ß√£o e carregar dados
        async function inicializar() {
            try {
                // Verificar autentica√ß√£o
                const response = await fetch('/api/usuario/atual', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                const user = await response.json();
                
                if (user.tipo !== 'cliente') {
                    alert('Apenas clientes podem agendar consultas.');
                    window.location.href = '/home';
                    return;
                }
                
                // Carregar informa√ß√µes do psic√≥logo
                if (!idPsicologo) {
                    mostrarErro('Psic√≥logo n√£o especificado.');
                    return;
                }

                const psicologosResponse = await fetch('/api/psicologos', {
                    credentials: 'include'
                });

                const psicologos = await psicologosResponse.json();
                // CORRE√á√ÉO: Buscar por id_psicologo em vez de id_usuario
                psicologoInfo = psicologos.find(p => p.id_psicologo == idPsicologo);

                if (!psicologoInfo) {
                    mostrarErro('Psic√≥logo n√£o encontrado.');
                    return;
                }
                
                mostrarPsicologoInfo();
                configurarFormulario();
                
            } catch (error) {
                console.error('Erro:', error);
                window.location.href = '/agendar';
            }
        }
        
        // Mostrar informa√ß√µes do psic√≥logo
        function mostrarPsicologoInfo() {
            document.getElementById('psicologo-info').innerHTML = `
                <h2>üë®‚Äç‚öïÔ∏è ${psicologoInfo.nome}</h2>
                <p style="color: rgba(255, 255, 255, 0.8);">
                    ${psicologoInfo.especialidade || 'Psic√≥logo'} | CRP: ${psicologoInfo.CRP || 'N/I'}
                </p>
                <p style="margin-top: 10px;">
                    <strong>Experi√™ncia:</strong> ${psicologoInfo.experiencia || 0} anos<br>
                    <strong>Avalia√ß√£o:</strong> ‚≠ê ${psicologoInfo.avaliacao_media || '0.00'} (${psicologoInfo.total_avaliacoes || 0} avalia√ß√µes)
                </p>
            `;
        }
        
        // Configurar formul√°rio
        function configurarFormulario() {
            const hoje = new Date();
            const amanha = new Date(hoje);
            amanha.setDate(amanha.getDate() + 1);
            
            const dataInput = document.getElementById('data');
            dataInput.min = amanha.toISOString().split('T')[0];
            
            // Sugerir data (pr√≥xima semana)
            const sugestao = new Date(hoje);
            sugestao.setDate(sugestao.getDate() + 7);
            dataInput.value = sugestao.toISOString().split('T')[0];
        }
        
        // Mostrar erro
        function mostrarErro(mensagem) {
            document.getElementById('psicologo-info').innerHTML = `
                <div class="error-message">
                    ‚ùå ${mensagem}
                    <button onclick="window.location.href='/agendar'" class="btn" style="margin-top: 10px;">
                        ‚Üê Voltar para lista
                    </button>
                </div>
            `;
            document.getElementById('formAgendamento').style.display = 'none';
        }
        
        // Enviar agendamento
        document.getElementById('formAgendamento').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = document.getElementById('data').value;
            const horario = document.getElementById('horario').value;
            const observacoes = document.getElementById('observacoes').value.trim();
            const btn = this.querySelector('.btn-success');
            
            if (!data || !horario) {
                alert('Selecione uma data e hor√°rio.');
                return;
            }
            
            btn.textContent = 'Agendando...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        id_psicologo: idPsicologo,
                        data: data,
                        horario: horario,
                        observacoes: observacoes
                    })
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    alert(`‚úÖ Consulta agendada com sucesso!\n\nCom: ${psicologoInfo.nome}\nData: ${data}\nHor√°rio: ${horario}`);
                    window.location.href = '/minhas_consultas';
                } else {
                    alert('‚ùå ' + resultado.error);
                    btn.textContent = '‚úÖ Confirmar Agendamento';
                    btn.disabled = false;
                }
                
            } catch (error) {
                alert('‚ùå Erro ao agendar consulta.');
                console.error('Erro:', error);
                btn.textContent = '‚úÖ Confirmar Agendamento';
                btn.disabled = false;
            }
        });
        
        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Inicializar
        window.onload = inicializar;
    </script>
</body>
</html>